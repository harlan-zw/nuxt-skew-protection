---
title: Server Utilities
description: Server-side utilities for version and cookie management.
---

Server-side utilities for working with skew protection in API routes and middleware.

## Import

```ts
import {
  getSkewProtectionCookie,
  isClientOutdated,
  setSkewProtectionCookie
} from 'nuxt-skew-protection/server'
```

## Functions

### `getSkewProtectionCookie(event)`

Get the version cookie from the request.

**Parameters:**

- `event`: `H3Event` - The H3 event object

**Returns:** `string | undefined` - The buildId from cookie, or `undefined` if not set

```ts
export default defineEventHandler((event) => {
  const version = getSkewProtectionCookie(event)

  if (!version) {
    return { error: 'Version cookie not found' }
  }

  console.log('User version:', version)
})
```

### `setSkewProtectionCookie(event, buildId)`

Set the version cookie on the response.

**Parameters:**

- `event`: `H3Event` - The H3 event object
- `buildId`: `string` - The buildId to set

**Returns:** `void`

```ts
export default defineEventHandler((event) => {
  const newBuildId = 'abc123'

  setSkewProtectionCookie(event, newBuildId)

  return { success: true }
})
```

### `isClientOutdated(event)`

Check if the client's version is outdated.

**Parameters:**

- `event`: `H3Event` - The H3 event object

**Returns:** `boolean` - `true` if client version doesn't match current buildId

```ts
export default defineEventHandler((event) => {
  const outdated = isClientOutdated(event)

  if (outdated) {
    return {
      status: 'outdated',
      message: 'Please refresh to get the latest version'
    }
  }

  return { status: 'ok' }
})
```

## Examples

### API Route with Version Check

```ts [server/api/data.ts]
import { isClientOutdated } from 'nuxt-skew-protection/server'

export default defineEventHandler(async (event) => {
  // Check if client is outdated
  if (isClientOutdated(event)) {
    throw createError({
      statusCode: 409,
      message: 'Client version outdated. Please refresh.'
    })
  }

  // Proceed with API logic
  const data = await fetchData()
  return data
})
```

### Custom Middleware

```ts [server/middleware/check-version.ts]
import { getSkewProtectionCookie, isClientOutdated } from 'nuxt-skew-protection/server'

export default defineEventHandler((event) => {
  const path = event.path

  // Only check on API routes
  if (!path.startsWith('/api/')) {
    return
  }

  const userVersion = getSkewProtectionCookie(event)

  if (!userVersion) {
    console.warn('No version cookie found')
    return
  }

  if (isClientOutdated(event)) {
    console.log(`Outdated client detected: ${userVersion}`)

    // Add header to inform client
    setResponseHeader(event, 'X-Client-Outdated', 'true')
  }
})
```

### Version-Specific Responses

```ts [server/api/config.ts]
import { getSkewProtectionCookie } from 'nuxt-skew-protection/server'

export default defineEventHandler((event) => {
  const version = getSkewProtectionCookie(event)

  // Return version-specific configuration
  const config = getConfigForVersion(version)

  return {
    version,
    config
  }
})
```

### Force Cookie Update

```ts [server/api/force-update.ts]
import { useRuntimeConfig } from '#imports'
import { setSkewProtectionCookie } from 'nuxt-skew-protection/server'

export default defineEventHandler((event) => {
  const config = useRuntimeConfig()

  // Force client to use current version
  setSkewProtectionCookie(event, config.app.buildId)

  return {
    message: 'Cookie updated to current version',
    buildId: config.app.buildId
  }
})
```

### Gradual Rollout

```ts [server/middleware/gradual-rollout.ts]
import { useRuntimeConfig } from '#imports'
import { getSkewProtectionCookie, setSkewProtectionCookie } from 'nuxt-skew-protection/server'

export default defineEventHandler((event) => {
  const config = useRuntimeConfig()
  const userVersion = getSkewProtectionCookie(event)

  // Only target HTML requests
  if (!event.path.match(/\.html$|\/$/)) {
    return
  }

  // 10% gradual rollout to new version
  const rolloutPercentage = 0.1
  const random = Math.random()

  if (random < rolloutPercentage && userVersion !== config.app.buildId) {
    console.log('Rolling out new version to user')
    setSkewProtectionCookie(event, config.app.buildId)
  }
})
```

### Debug Endpoint

```ts [server/api/_debug/version.ts]
import { useRuntimeConfig } from '#imports'
import {
  getSkewProtectionCookie,
  isClientOutdated
} from 'nuxt-skew-protection/server'

export default defineEventHandler((event) => {
  const config = useRuntimeConfig()
  const userVersion = getSkewProtectionCookie(event)

  return {
    currentBuildId: config.app.buildId,
    userVersion,
    isOutdated: isClientOutdated(event),
    headers: getHeaders(event)
  }
})
```

### Webhook Handler

```ts [server/api/webhooks/deploy.ts]
import { setSkewProtectionCookie } from 'nuxt-skew-protection/server'

export default defineEventHandler(async (event) => {
  const body = await readBody(event)

  // Validate webhook
  if (body.secret !== process.env.WEBHOOK_SECRET) {
    throw createError({ statusCode: 401 })
  }

  // New deployment detected
  const newBuildId = body.buildId

  console.log('New deployment:', newBuildId)

  // Update cookie for this request (if needed)
  setSkewProtectionCookie(event, newBuildId)

  return { success: true }
})
```

### A/B Testing Integration

```ts [server/middleware/ab-test.ts]
import { getSkewProtectionCookie, setSkewProtectionCookie } from 'nuxt-skew-protection/server'

export default defineEventHandler((event) => {
  const userVersion = getSkewProtectionCookie(event)
  const experimentVersion = 'experiment-abc'

  // 50% of users get experimental version
  if (!userVersion && Math.random() < 0.5) {
    setSkewProtectionCookie(event, experimentVersion)
    event.context.experiment = true
  }
})
```

## Access Build Metadata

Get the current build ID from runtime config:

```ts
import { useRuntimeConfig } from '#imports'

export default defineEventHandler((event) => {
  const config = useRuntimeConfig()

  const currentBuildId = config.app.buildId

  return {
    buildId: currentBuildId,
    buildTimestamp: config.app.buildAssetsDir
  }
})
```

## Cookie Configuration

The cookie settings from `nuxt.config.ts` are applied:

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  skewProtection: {
    cookie: {
      name: '__nkpv',
      path: '/',
      sameSite: 'strict',
      secure: process.env.NODE_ENV === 'production',
      maxAge: 60 * 60 * 24 * 60, // 60 days
      httpOnly: false // Must be false for client access
    }
  }
})
```

## Type Definitions

```ts
import type { H3Event } from 'h3'

function getSkewProtectionCookie(event: H3Event): string | undefined
function setSkewProtectionCookie(event: H3Event, buildId: string): void
function isClientOutdated(event: H3Event): boolean
```

## Notes

- **Cookie must be readable by client** - Don't set `httpOnly: true`
- **Automatically set by middleware** - Manual setting usually not needed
- **Use `isClientOutdated()`** for simple checks instead of manual comparison
- **Available in all server contexts** - Event handlers, middleware, etc.

## See Also

- [useSkewProtectionCookie](/docs/skew-protection/api/use-skew-protection-cookie) - Client-side cookie access
- [useSkewProtection](/docs/skew-protection/api/use-skew-protection) - Client composable
- [Config Reference](/docs/skew-protection/api/config) - Cookie configuration
