---
title: Storage Configuration
description: Configure persistent storage for build assets across deployments.
---

Nuxt Skew Protection uses [unstorage](https://unstorage.unjs.io/) to store versioned assets and metadata. Choose the right storage driver for your platform and deployment workflow.

## Why Storage Matters

The module stores:

- **Version manifest** - Tracks all build versions, timestamps, and assets
- **Build assets** - Previous version's `_nuxt/*.js|css` files (with deduplication)
- **Metadata** - Deleted chunks, file ID mappings

This data **must persist across deployments** for the module to work correctly.

## Storage Drivers

### Filesystem (Default)

Best for: Development, Node.js servers with persistent storage

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  skewProtection: {
    storage: {
      driver: 'fs',
      base: 'node_modules/.cache/nuxt/skew-protection'
    }
  }
})
```

**Pros:**

- ✅ Zero configuration
- ✅ Fast local access
- ✅ No external dependencies

**Cons:**

- ❌ Not suitable for serverless (ephemeral filesystem)
- ❌ Lost on container restarts
- ❌ Can't be shared across instances

### Vercel KV

Best for: Vercel deployments

```bash
# Install
npm install @vercel/kv
```

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  skewProtection: {
    storage: {
      driver: 'vercel-kv',
      url: process.env.KV_REST_API_URL,
      token: process.env.KV_REST_API_TOKEN
    }
  }
})
```

**Setup:**

1. Create KV store in Vercel dashboard
2. Link to your project
3. Environment variables are auto-configured

**Pros:**

- ✅ Managed by Vercel
- ✅ Auto-configured in Vercel environment
- ✅ Fast, distributed
- ✅ Integrated billing

**Cons:**

- ⚠️ Vercel-specific
- ⚠️ Costs on high usage

### Cloudflare KV

Best for: Cloudflare Workers/Pages

Uses wrangler CLI commands during build for fast, authenticated access to Cloudflare KV. No API tokens needed - leverages your existing wrangler authentication.

**Setup:**

1. Create KV namespace:

   ```bash
   wrangler kv:namespace create "SKEW_STORAGE"
   ```

2. Add to wrangler.toml:

   ```toml
   [[kv_namespaces]]
   binding = "SKEW_STORAGE"
   id = "your-namespace-id" # From step 1
   ```

3. Configure in nuxt.config.ts:

   ```ts
   export default defineNuxtConfig({
     skewProtection: {
       storage: {
         driver: 'cloudflare-kv-binding',
         namespaceId: 'your-namespace-id' // Auto-detected from wrangler.toml if omitted
       }
     }
   })
   ```

The module will:

- ✅ Use wrangler CLI commands for direct KV access during build (fast!)
- ✅ Use your existing wrangler authentication (no API token needed)
- ✅ Auto-detect namespaceId from wrangler.toml if not provided

**Pros:**

- ✅ Uses existing wrangler authentication
- ✅ No API token needed
- ✅ Fast local builds
- ✅ Native Cloudflare integration
- ✅ Global distribution
- ✅ Generous free tier
- ✅ Low latency

**Cons:**

- ⚠️ Eventual consistency (usually <60s)
- ⚠️ Cloudflare-specific

### Redis

Best for: High-traffic apps, shared storage across instances

```bash
# Install
npm install ioredis
```

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  skewProtection: {
    storage: {
      driver: 'redis',
      host: process.env.REDIS_HOST || 'localhost',
      port: Number(process.env.REDIS_PORT) || 6379,
      password: process.env.REDIS_PASSWORD,
      db: 0,
      base: 'skew-protection'
    }
  }
})
```

**Pros:**

- ✅ Shared across instances
- ✅ Fast in-memory storage
- ✅ Persistence options
- ✅ Works anywhere

**Cons:**

- ⚠️ Requires Redis server
- ⚠️ Additional infrastructure
- ⚠️ Cost of managed Redis

**Popular Redis Providers:**

- [Upstash](https://upstash.com/) - Serverless Redis
- [Redis Cloud](https://redis.com/cloud/overview/)
- [AWS ElastiCache](https://aws.amazon.com/elasticache/)

### S3-Compatible Storage

Best for: AWS, large storage needs, backups

```bash
# Install
npm install @aws-sdk/client-s3
```

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  skewProtection: {
    storage: {
      driver: 's3',
      bucket: process.env.S3_BUCKET,
      region: process.env.AWS_REGION || 'us-east-1',
      accessKeyId: process.env.AWS_ACCESS_KEY_ID,
      secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
      endpoint: process.env.S3_ENDPOINT // Optional for S3-compatible services
    }
  }
})
```

**Pros:**

- ✅ Unlimited storage
- ✅ Works with S3, R2, MinIO, etc.
- ✅ Cheap storage costs
- ✅ Highly available

**Cons:**

- ⚠️ Higher latency than KV stores
- ⚠️ More complex setup
- ⚠️ API request costs

**S3-Compatible Services:**

- AWS S3
- Cloudflare R2 (no egress fees!)
- DigitalOcean Spaces
- MinIO (self-hosted)

### MongoDB

Best for: Apps already using MongoDB

```bash
# Install
npm install mongodb
```

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  skewProtection: {
    storage: {
      driver: 'mongodb',
      connectionString: process.env.MONGODB_URI,
      databaseName: 'myapp',
      collectionName: 'skew-protection'
    }
  }
})
```

### Planetscale

Best for: Apps using Planetscale MySQL

```bash
# Install
npm install @planetscale/database
```

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  skewProtection: {
    storage: {
      driver: 'planetscale',
      url: process.env.DATABASE_URL
    }
  }
})
```

### Custom Driver

Implement your own storage driver:

```ts [storage-driver.ts]
import { defineDriver } from 'unstorage'

export default defineDriver((opts) => {
  return {
    name: 'my-custom-driver',
    options: opts,
    async hasItem(key) {
      // Check if key exists
    },
    async getItem(key) {
      // Get value for key
    },
    async setItem(key, value) {
      // Set value for key
    },
    async removeItem(key) {
      // Remove key
    },
    async getKeys(base) {
      // List keys with prefix
    },
    async clear(base) {
      // Remove all keys with prefix
    }
  }
})
```

```ts [nuxt.config.ts]
import myDriver from './storage-driver'

export default defineNuxtConfig({
  skewProtection: {
    storage: {
      driver: myDriver,
      // Your driver options
    }
  }
})
```

## Platform Recommendations

| Platform | Recommended Storage | Alternative |
|----------|-------------------|-------------|
| **Vercel** | Vercel KV | Redis (Upstash) |
| **Cloudflare Workers** | Cloudflare KV (HTTP) | Cloudflare R2 |
| **Cloudflare Pages** | Cloudflare KV (HTTP) | - |
| **Netlify** | Upstash Redis | S3 |
| **AWS (EC2/ECS)** | Redis (ElastiCache) | S3 |
| **Heroku** | Redis (Heroku Redis) | - |
| **Railway** | Redis (Railway) | - |
| **Fly.io** | Upstash Redis | Tigris (S3-compatible) |
| **Digital Ocean** | Redis | Spaces (S3-compatible) |
| **Self-hosted** | Filesystem | Redis |

## Storage Keys Structure

The module uses this key structure:

```
skew-protection/
├── version-manifest          # Main manifest with all versions
└── {buildId}/               # Assets for specific version
    ├── _nuxt/entry.abc.js
    ├── _nuxt/chunk.def.js
    └── ...
```

Example keys:

- `skew-protection:version-manifest`
- `skew-protection:abc123/_nuxt/entry.abc123.js`
- `skew-protection:abc123/_nuxt/chunk.def456.js`

## Storage Size Considerations

### Deduplication

The module automatically deduplicates assets with the same hash:

```ts
// Same file hash across versions = stored once
// Version 1: entry.ABC123.js
// Version 2: entry.ABC123.js (reused, not stored again)
```

### Retention Settings

Control how long versions are kept:

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  skewProtection: {
    // Keep versions for 30 days
    retentionDays: 30,

    // Keep maximum 10 versions
    maxNumberOfVersions: 10
  }
})
```

Cleanup happens **during build**, removing:

- Versions older than `retentionDays`
- Oldest versions beyond `maxNumberOfVersions`

### Estimating Storage Needs

**Example calculation:**

- Nuxt app bundle: ~2MB
- Unique chunks per version: ~1MB (after deduplication)
- Versions retained: 10
- **Total storage: ~12MB**

For most apps: **< 50MB total** with default settings.

## Testing Storage

### Verify Storage Connection

```bash
# Build the app
npm run build

# Check logs for storage operations
# Should see:
# ✓ Stored 15 assets for version abc123
# ✓ Restored 8 assets from 2 previous versions
```

### Inspect Stored Data

::code-group

```bash [Filesystem]
# List versions
ls -la node_modules/.cache/nuxt/skew-protection/

# View manifest
cat node_modules/.cache/nuxt/skew-protection/version-manifest
```

```bash [Redis]
# List all keys
redis-cli --scan --pattern "skew-protection:*"

# View manifest
redis-cli GET "skew-protection:version-manifest"
```

```bash [Vercel KV]
# Use Vercel CLI
vercel kv:list SKEW_PROTECTION_KV
```

::

### Test Asset Retrieval

```bash
# Check that old assets are in public/_nuxt/
ls -la .output/public/_nuxt/

# Should contain files from current AND previous versions
```

## Troubleshooting Storage

### Assets Not Persisting

**Problem:** Old assets disappear after deployment

**Solution:**

1. Verify storage driver is configured correctly
2. Check storage credentials/permissions
3. Ensure storage persists across deployments (not ephemeral)

### Storage Quota Exceeded

**Problem:** Running out of storage space

**Solutions:**

1. Reduce retention:

   ```ts
   export default defineNuxtConfig({
     skewProtection: {
       retentionDays: 7,
       maxNumberOfVersions: 5
     }
   })
   ```

2. Switch to larger storage (S3, R2)

3. Manually clear old versions:

   ```bash
   # Clear all skew protection storage
   redis-cli --scan --pattern "skew-protection:*" | xargs redis-cli DEL
   ```

### Slow Build Times

**Problem:** Asset storage/restore takes too long

**Solutions:**

1. Use faster storage (Redis/KV > S3 > Filesystem)
2. Reduce `maxNumberOfVersions`
3. Enable storage driver's compression (if available)

## Migration Between Drivers

When changing storage drivers, the module will start fresh. To migrate:

1. **Export current manifest:**

   ```bash
   # If using filesystem
   cp node_modules/.cache/nuxt/skew-protection/version-manifest ./backup.json
   ```

2. **Update configuration:**

   ```ts
   export default defineNuxtConfig({
     skewProtection: {
       storage: {
         driver: 'redis', // New driver
         // ...
       }
     }
   })
   ```

3. **Import manifest (optional):**

   ```ts
   // In a build script
   const backup = JSON.parse(fs.readFileSync('./backup.json', 'utf-8'))
   await storage.setItem('version-manifest', backup)
   ```

4. **Rebuild:**

   ```bash
   npm run build
   ```

## Next Steps

- [Update Strategies](/docs/skew-protection/guides/update-strategies) - Configure update detection
- [Platform Guides](/docs/skew-protection/guides/platforms) - Platform-specific setup
- [Config Reference](/docs/skew-protection/api/config) - All configuration options
